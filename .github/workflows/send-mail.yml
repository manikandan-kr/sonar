name: Send Mail

on:
  workflow_call:
    inputs:
      subject:
        required: true
        type: string
      message:
        required: true
        type: string
      status:
        required: true
        type: string
      from:
        required: true
        type: string
      to:
        required: true
        type: string
    secrets:
      MAIL_TENANT_ID:
        required: true
      MAIL_CLIENT_ID:
        required: true
      MAIL_CLIENT_SECRET:
        required: true

jobs:
  send_mail:
    runs-on: ubuntu-latest

    steps:
      - name: Determine Color
        id: color
        run: |
          if [[ "${{ inputs.status }}" == "success" ]]; then
            echo "color=green" >> $GITHUB_OUTPUT
          else
            echo "color=red" >> $GITHUB_OUTPUT
          fi

      - name: Build HTML Email
        id: html
        run: |
          cat > email.html <<EOF
          <html>
          <body style="font-family: Arial, sans-serif;">
            <div style="padding:20px;border:1px solid #dcdcdc;border-radius:8px;">
              <h2 style="color:${{ steps.color.outputs.color }};">
                ${{ inputs.subject }}
              </h2>

              <p style="font-size:14px;">
                ${{ inputs.message }}
              </p>

              <hr/>
              <p style="color:gray;font-size:12px;">
                Automated Notification from GitHub Actions
              </p>
            </div>
          </body>
          </html>
          EOF

      - name: Get Access Token
        id: token
        run: |
          AUTH=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ secrets.MAIL_CLIENT_ID }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "client_secret=${{ secrets.MAIL_CLIENT_SECRET }}" \
            -d "grant_type=client_credentials" \
            "https://login.microsoftonline.com/${{ secrets.MAIL_TENANT_ID }}/oauth2/v2.0/token")

          echo "token=$(echo $AUTH | jq -r '.access_token')" >> $GITHUB_OUTPUT

      - name: Send HTML Email (Multi-Recipient)
        run: |
          BODY=$(sed 's/"/\\"/g' email.html | tr -d '\n')

          # Build JSON recipient array from comma-separated list
          RECIPIENTS=""
          IFS=',' read -ra ADDR <<< "${{ inputs.to }}"
          for email in "${ADDR[@]}"; do
            email_trimmed=$(echo "$email" | xargs)
            RECIPIENTS="$RECIPIENTS{\"emailAddress\":{\"address\":\"$email_trimmed\"}},"
          done

          # Remove trailing comma and wrap in array brackets
          RECIPIENTS="[${RECIPIENTS%,}]"

          curl -s -X POST \
            -H "Authorization: Bearer ${{ steps.token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": {
                \"subject\": \"${{ inputs.subject }}\",
                \"body\": {
                  \"contentType\": \"HTML\",
                  \"content\": \"$BODY\"
                },
                \"toRecipients\": $RECIPIENTS
              },
              \"saveToSentItems\": \"false\"
            }" \
            "https://graph.microsoft.com/v1.0/users/${{ inputs.from }}/sendMail"
 