name: Rollback Deployment (Rebuild-Based)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to rollback to"
        required: true
        type: string
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [dev]

permissions:
  contents: write
  packages: write

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
    ########################################################################
    # Step 1 — Validate Tag Exists
    ########################################################################
    - name: Validate Tag Exists
      id: validate
      run: |
        TAG="${{ github.event.inputs.tag }}"
        REPO="${{ github.repository }}"

        echo "Validating tag: $TAG"
        if ! git ls-remote --tags https://github.com/$REPO.git | grep -q "refs/tags/$TAG$"; then
          echo "ERROR: Tag $TAG does not exist!"
          exit 1
        fi
        echo "Tag exists."

    ########################################################################
    # Step 2 — Checkout Tag
    ########################################################################
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Tag Into New Branch
      run: |
        TAG="${{ github.event.inputs.tag }}"
        BRANCH="rollback_${TAG}"

        echo "Creating branch $BRANCH from tag $TAG"
        git checkout "tags/$TAG" -b "$BRANCH"

    ########################################################################
    # Step 3 — Build New Container Image
    ########################################################################
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ secrets.GIT_USERNAME }}
        password: ${{ secrets.GIT_PAT }}

    - name: Build Container Image
      id: build
      run: |
        TAG="${{ github.event.inputs.tag }}"
        IMAGE="ghcr.io/${{ github.repository_owner }}/dxc-content-agent:${TAG}-rollback"

        echo "Building rollback image: $IMAGE"
        docker build -t "$IMAGE" .

        echo "image=$IMAGE" >> $GITHUB_OUTPUT

    - name: Push Image to GHCR
      run: |
        echo "Pushing image: ${{ steps.build.outputs.image }}"
        docker push "${{ steps.build.outputs.image }}"

    ########################################################################
    # Step 4 — Deploy Rollback Version to Azure (DEV)
    ########################################################################
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Rollback to Azure Container Apps
      id: deploy
      run: |
        IMAGE="${{ steps.build.outputs.image }}"
        APP="dev-container"
        RG="DXC-Agent"

        echo "Deploying rollback image to Azure: $IMAGE"

        az containerapp update \
          --name "$APP" \
          --resource-group "$RG" \
          --image "$IMAGE"

        echo "deploy_status=SUCCESS" >> $GITHUB_OUTPUT

    ########################################################################
    # Step 5 — Update GitHub Release Notes
    ########################################################################
    - name: Update Release Info
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.event.inputs.tag }}
        name: "Rollback - ${{ github.event.inputs.tag }}"
        body: "Rollback completed successfully. New rollback image deployed."
        allowUpdates: true


    ########################################################################
    # Step 6 — Notification Email (Using Reusable Workflow)
    ########################################################################
    - name: Send Notification Email
      if: always()
      uses: ./.github/workflows/send-mail.yml
      with:
        subject: "Rollback Result - ${{ github.event.inputs.tag }}"
        message: |
          Rollback Result:
          Tag: ${{ github.event.inputs.tag }}
          Environment: ${{ github.event.inputs.environment }}
          Status: ${{ steps.deploy.outputs.deploy_status || 'FAILED' }}

        status: ${{ steps.deploy.outputs.deploy_status == 'SUCCESS' && 'success' || 'failed' }}
        from: "manikandan.ramamoorthy@cxontology.com"
        to: "manikandan.ramamoorthy@cxontology.com"

      secrets:
        MAIL_TENANT_ID: ${{ secrets.MAIL_TENANT_ID }}
        MAIL_CLIENT_ID: ${{ secrets.MAIL_CLIENT_ID }}
        MAIL_CLIENT_SECRET: ${{ secrets.MAIL_CLIENT_SECRET }}


    # ########################################################################
    # # Step 6 — Notification Email
    # ########################################################################
    # - name: Send Email Notification
    #   if: always()
    #   uses: dawidd6/action-send-mail@v3
    #   with:
    #     server_address: smtp.gmail.com
    #     server_port: 587
    #     username: ${{ secrets.EMAIL_USER }}
    #     password: ${{ secrets.EMAIL_PASSWORD }}
    #     subject: "Rollback Result - ${{ github.event.inputs.tag }}"
    #     to: "team@example.com"
    #     from: "GitHub Rollback <no-reply@example.com>"
    #     body: |
    #       Rollback Result:
    #       Tag: ${{ github.event.inputs.tag }}
    #       Environment: ${{ github.event.inputs.environment }}
    #       Status: ${{ steps.deploy.outputs.deploy_status || 'FAILED' }}
