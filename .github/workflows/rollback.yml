# name: Rollback Deployment (Rebuild-Based)

# on:
#   workflow_dispatch:
#     inputs:
#       tag:
#         description: "Tag to rollback to"
#         required: true
#         type: string
#       environment:
#         description: "Environment"
#         required: true
#         type: choice
#         options: [dev]

# permissions:
#   contents: write
#   packages: write

# jobs:
#   rollback:
#     runs-on: ubuntu-latest

#     steps:
#     ########################################################################
#     # Step 1 — Validate Tag Exists
#     ########################################################################
#     - name: Validate Tag Exists
#       id: validate
#       run: |
#         TAG="${{ github.event.inputs.tag }}"
#         REPO="${{ github.repository }}"

#         echo "Validating tag: $TAG"
#         if ! git ls-remote --tags https://github.com/$REPO.git | grep -q "refs/tags/$TAG$"; then
#           echo "ERROR: Tag $TAG does not exist!"
#           exit 1
#         fi
#         echo "Tag exists."

#     ########################################################################
#     # Step 2 — Checkout Tag
#     ########################################################################
#     - name: Checkout Repository
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: Checkout Tag Into New Branch
#       run: |
#         TAG="${{ github.event.inputs.tag }}"
#         BRANCH="rollback_${TAG}"

#         echo "Creating branch $BRANCH from tag $TAG"
#         git checkout "tags/$TAG" -b "$BRANCH"

#     ########################################################################
#     # Step 3 — Build New Container Image
#     ########################################################################
#     - name: Login to GHCR
#       uses: docker/login-action@v3
#       with:
#         registry: ghcr.io
#         username: ${{ secrets.GIT_USERNAME }}
#         password: ${{ secrets.GIT_PAT }}

#     - name: Build Container Image
#       id: build
#       run: |
#         TAG="${{ github.event.inputs.tag }}"
#         IMAGE="ghcr.io/${{ github.repository_owner }}/dxc-content-agent:${TAG}-rollback"

#         echo "Building rollback image: $IMAGE"
#         docker build -t "$IMAGE" .

#         echo "image=$IMAGE" >> $GITHUB_OUTPUT

#     - name: Push Image to GHCR
#       run: |
#         echo "Pushing image: ${{ steps.build.outputs.image }}"
#         docker push "${{ steps.build.outputs.image }}"

#     ########################################################################
#     # Step 4 — Deploy Rollback Version to Azure (DEV)
#     ########################################################################
#     - name: Azure Login
#       uses: azure/login@v2
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     - name: Deploy Rollback to Azure Container Apps
#       id: deploy
#       run: |
#         IMAGE="${{ steps.build.outputs.image }}"
#         APP="dev-container"
#         RG="DXC-Agent"

#         echo "Deploying rollback image to Azure: $IMAGE"

#         az containerapp update \
#           --name "$APP" \
#           --resource-group "$RG" \
#           --image "$IMAGE"

#         echo "deploy_status=SUCCESS" >> $GITHUB_OUTPUT

#     ########################################################################
#     # Step 5 — Update GitHub Release Notes
#     ########################################################################
#     - name: Update Release Info
#       uses: ncipollo/release-action@v1
#       with:
#         tag: ${{ github.event.inputs.tag }}
#         name: "Rollback - ${{ github.event.inputs.tag }}"
#         body: "Rollback completed successfully. New rollback image deployed."
#         allowUpdates: true

#   ########################################################################
#   # Step 6 — SUCCESS EMAIL NOTIFICATION
#   ########################################################################
#   success_email:
#     needs: rollback
#     if: success()
#     uses: ./.github/workflows/send-mail.yml
#     secrets: inherit
#     with:
#       subject: "Rollback SUCCESS - Tag: ${{ github.event.inputs.tag }}"
#       message: |
#         <b>Rollback Completed Successfully</b><br><br>

#         <b>Tag:</b> ${{ github.event.inputs.tag }}<br>
#         <b>Environment:</b> ${{ github.event.inputs.environment }}<br>
#         <b>Status:</b> SUCCESS<br>

#       status: success
#       from: "manikandan.ramamoorthy@cxontology.com"
#       to: "manikandan.ramamoorthy@cxontology.com"

#   ########################################################################
#   # Step 7 — FAILURE EMAIL NOTIFICATION
#   ########################################################################
#   failure_email:
#     needs: rollback
#     if: failure()
#     uses: ./.github/workflows/send-mail.yml
#     secrets: inherit
#     with:
#       subject: "Rollback FAILURE - Tag: ${{ github.event.inputs.tag }}"
#       message: |
#         <b>Rollback Failed!</b><br><br>

#         <b>Tag:</b> ${{ github.event.inputs.tag }}<br>
#         <b>Environment:</b> ${{ github.event.inputs.environment }}<br>
#         <b>Status:</b> FAILED<br>

#       status: failure
#       from: "manikandan.ramamoorthy@cxontology.com"
#       to: "manikandan.ramamoorthy@cxontology.com"



name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Choose Environment to Rollback"
        type: choice
        required: true
        options:
          - dev

      tag:
        description: "Tag to rollback to (ex: Release_V5)"
        required: true

permissions:
  contents: write
  packages: write

jobs:
  rollback:
    runs-on: ubuntu-latest

    outputs:
      status: ${{ steps.result.outputs.status || steps.result_error.outputs.status }}
      tag: ${{ steps.result.outputs.tag || steps.result_error.outputs.tag }}
      error: ${{ steps.result_error.outputs.error }}

    steps:
      # -----------------------------------------------------------
      # Checkout main repository
      # -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------
      # Validate Tag Exists
      # -----------------------------------------------------------
      - name: Validate Tag
        id: validate
        run: |
          echo "Checking Tag: ${{ github.event.inputs.tag }}"
          if ! git rev-parse "refs/tags/${{ github.event.inputs.tag }}" >/dev/null 2>&1; then
            echo "Tag does not exist"
            exit 1
          fi
        shell: bash

      # -----------------------------------------------------------
      # Checkout Code of Selected Tag
      # -----------------------------------------------------------
      - name: Checkout Tagged Source
        run: |
          git checkout tags/${{ github.event.inputs.tag }}
        shell: bash

      # -----------------------------------------------------------
      # Map environment to Azure resources
      # -----------------------------------------------------------
      - name: Select Deployment Settings
        id: envmap
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "container=dev-container" >> $GITHUB_OUTPUT
            echo "resource_group=DXC-Agent" >> $GITHUB_OUTPUT
            echo "container_env=DXC-agent" >> $GITHUB_OUTPUT
            echo "location=centralindia" >> $GITHUB_OUTPUT
      
      
          fi

      # -----------------------------------------------------------
      # Azure Login
      # -----------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------
      # Login to GHCR
      # -----------------------------------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GIT_USERNAME }}
          password: ${{ secrets.GIT_PAT }}

      # -----------------------------------------------------------
      # Build container from this tag and deploy
      # -----------------------------------------------------------
      - name: Build & Deploy Container App
        id: deploy
        uses: azure/container-apps-deploy-action@v1
        with:
          appSourcePath: ${{ github.workspace }}
          registryUrl: ghcr.io
          registryUsername: ${{ secrets.GIT_USERNAME }}
          registryPassword: ${{ secrets.GIT_PAT }}
          containerAppName: ${{ steps.envmap.outputs.container }}
          resourceGroup: ${{ steps.envmap.outputs.resource_group }}
          containerAppEnvironment: ${{ steps.envmap.outputs.container_env }}
          location: ${{ steps.envmap.outputs.location }}
          imageToBuild: ghcr.io/${{ secrets.GIT_USERNAME }}/dxc-content-agent:${{ github.event.inputs.tag }}

      # -----------------------------------------------------------
      # Store success output
      # -----------------------------------------------------------
      - name: Store success output
        if: success()
        id: result
        run: |
          echo "status=success" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Capture failure
      # -----------------------------------------------------------
      - name: Capture Error
        if: failure()
        id: result_error
        run: |
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "error=Rollback failed at deployment" >> $GITHUB_OUTPUT

  # ============================================================
  # SUCCESS EMAIL
  # ============================================================
  rollback_success_email:
    needs: rollback
    if: needs.rollback.outputs.status == 'success'
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "ROLLBACK SUCCESS — ${{ needs.rollback.outputs.tag }}"
      message: |
        <b>Rollback Completed Successfully</b><br/>
        <b>Tag:</b> ${{ needs.rollback.outputs.tag }}<br/>
        <b>Environment:</b> ${{ github.event.inputs.environment }}<br/>
      status: success
      from: "manikandan.ramamoorthy@cxontology.com"
      to: "manikandan.ramamoorthy@cxontology.com"

  # ============================================================
  # FAILURE EMAIL
  # ============================================================
  rollback_failure_email:
    needs: rollback
    if: needs.rollback.outputs.status == 'failure'
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "ROLLBACK FAILED — ${{ needs.rollback.outputs.tag }}"
      message: |
        <b>Rollback Failed</b><br/>
        <b>Tag:</b> ${{ needs.rollback.outputs.tag }}<br/>
        <b>Error:</b> ${{ needs.rollback.outputs.error }}<br/>
        <b>Environment:</b> ${{ github.event.inputs.environment }}<br/>
      status: failure
      from: "manikandan.ramamoorthy@cxontology.com"
      to: "manikandan.ramamoorthy@cxontology.com"
