name: Rollback Deployment (Rebuild-Based)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release Tag to Rollback (Example: Release_V2)"
        required: true
        type: string
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [prod]

permissions:
  contents: write
  packages: write

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
    ########################################################################
    # Step 1 — Validate Tag Exists
    ########################################################################
    - name: Validate Tag Exists
      id: validate
      run: |
        TAG="${{ github.event.inputs.tag }}"
        REPO="${{ github.repository }}"

        echo "Validating tag: $TAG"
        git ls-remote --tags https://github.com/$REPO.git | grep "refs/tags/$TAG$"

        if [ $? -ne 0 ]; then
          echo "ERROR: Tag $TAG does not exist!"
          echo "rollback_status=FAILED" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "Tag $TAG found."

    ########################################################################
    # Step 2 — Checkout Code using rollback branch
    ########################################################################
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Tag Into New Branch
      run: |
        TAG="${{ github.event.inputs.tag }}"
        BRANCH="rollback_${TAG}"

        echo "Creating branch $BRANCH from tag $TAG"
        git checkout "tags/$TAG" -b "$BRANCH"

    ########################################################################
    # Step 3 — Build New Container Image
    ########################################################################
    - name: Login to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build Container Image
      id: build
      run: |
        TAG="${{ github.event.inputs.tag }}"
        IMAGE="ghcr.io/${{ github.repository_owner }}/dxc-content-agent:${TAG}-rollback"

        echo "Building image: $IMAGE"
        docker build -t "$IMAGE" .

        echo "image=$IMAGE" >> $GITHUB_OUTPUT

    - name: Push Image to GHCR
      run: |
        echo "Pushing image: ${{ steps.build.outputs.image }}"
        docker push "${{ steps.build.outputs.image }}"

    ########################################################################
    # Step 4 — Deploy to Azure Container App (Prod)
    ########################################################################
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Container to Azure
      id: deploy
      run: |
        IMAGE="${{ steps.build.outputs.image }}"
        APP="dxc-content-agent-prod"
        RG="rg-prod"

        echo "Deploying rollback image to PROD: $IMAGE"

        az containerapp update \
          --name "$APP" \
          --resource-group "$RG" \
          --image "$IMAGE"

        echo "deploy_status=SUCCESS" >> $GITHUB_OUTPUT

    ########################################################################
    # Step 5 — Update GitHub Release (Mark As Rolled Back)
    ########################################################################
    - name: Update GitHub Release Info
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.event.inputs.tag }}
        name: "Rollback - ${{ github.event.inputs.tag }}"
        body: "Rollback performed. Image rebuilt and redeployed to PROD."
        allowUpdates: true

    ########################################################################
    # Step 6 — Email Notification
    ########################################################################
    - name: Send Email Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Rollback Result - ${{ github.event.inputs.tag }}"
        to: "team@example.com"
        from: "GitHub Rollback <no-reply@example.com>"
        body: |
          Rollback Result:
          Tag: ${{ github.event.inputs.tag }}
          Environment: ${{ github.event.inputs.environment }}
          Status: ${{ steps.deploy.outputs.deploy_status || 'FAILED' }}
